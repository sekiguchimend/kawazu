"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.shareFile = shareFile;
exports.listSharedFiles = listSharedFiles;
exports.downloadSharedFile = downloadSharedFile;
exports.revokeFileShare = revokeFileShare;
const chalk_1 = __importDefault(require("chalk"));
const inquirer_1 = __importDefault(require("inquirer"));
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const config_1 = require("../utils/config");
const file_1 = require("../utils/file");
async function shareFile(filePath, options = {}) {
    try {
        // ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
        if (!fs_extra_1.default.existsSync(filePath)) {
            console.error(chalk_1.default.red('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:'), filePath);
            return;
        }
        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—
        const absolutePath = path_1.default.resolve(filePath);
        const fileName = path_1.default.basename(absolutePath);
        const fileExt = path_1.default.extname(fileName);
        const fileType = options.type || getFileType(fileExt);
        // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹èª­ã¿å–ã‚Š
        const fileContent = await fs_extra_1.default.readFile(absolutePath, 'utf-8');
        if (fileContent.length > 1000000) { // 1MBåˆ¶é™
            console.error(chalk_1.default.red('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ (æœ€å¤§1MB)'));
            return;
        }
        console.log(chalk_1.default.blue(`ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰: ${fileName}`));
        // è¨­å®šå–å¾—
        const config = await (0, config_1.loadConfig)();
        if (!config.server_url) {
            console.error(chalk_1.default.red('âŒ ã‚µãƒ¼ãƒãƒ¼URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'));
            console.log(chalk_1.default.yellow('ğŸ’¡ è¨­å®šæ–¹æ³•: ') + chalk_1.default.cyan('kawazu config --server <URL>'));
            return;
        }
        // ãƒ«ãƒ¼ãƒ æƒ…å ±å–å¾—
        let roomSlug = options.room;
        if (!roomSlug) {
            roomSlug = await (0, file_1.getCurrentRoomFromCodechat)();
            if (!roomSlug) {
                console.error(chalk_1.default.red('âŒ ãƒ«ãƒ¼ãƒ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'));
                console.log(chalk_1.default.yellow('ğŸ’¡ --room ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ«ãƒ¼ãƒ ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'));
                return;
            }
        }
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åç¢ºèª
        const username = config.default_username;
        if (!username) {
            console.error(chalk_1.default.red('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'));
            console.log(chalk_1.default.yellow('ğŸ’¡ è¨­å®šæ–¹æ³•: ') + chalk_1.default.cyan('kawazu config --username <åå‰>'));
            return;
        }
        // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼è§£æ
        const targetUsers = options.users ? options.users.split(',').map(u => u.trim()) : [];
        // æ¨©é™è¨­å®š
        const permission = options.permission || 'read';
        // æœ‰åŠ¹æœŸé™è¨­å®š
        let expiryHours = 24;
        if (options.expires) {
            const hours = parseInt(options.expires);
            if (isNaN(hours) || hours <= 0) {
                console.error(chalk_1.default.red('âŒ ç„¡åŠ¹ãªæœ‰åŠ¹æœŸé™ã§ã™'));
                return;
            }
            expiryHours = hours;
        }
        // å…±æœ‰ç¢ºèª
        console.log(chalk_1.default.yellow('\nğŸ“‹ å…±æœ‰è¨­å®š:'));
        console.log(`  ãƒ•ã‚¡ã‚¤ãƒ«: ${chalk_1.default.cyan(fileName)}`);
        console.log(`  ãƒ«ãƒ¼ãƒ : ${chalk_1.default.cyan(roomSlug)}`);
        console.log(`  æ¨©é™: ${chalk_1.default.cyan(permission === 'read' ? 'èª­ã¿å–ã‚Šå°‚ç”¨' : 'èª­ã¿æ›¸ãå¯èƒ½')}`);
        console.log(`  å¯¾è±¡: ${targetUsers.length > 0 ? chalk_1.default.cyan(targetUsers.join(', ')) : chalk_1.default.cyan('å…¨å‚åŠ è€…')}`);
        console.log(`  æœ‰åŠ¹æœŸé™: ${chalk_1.default.cyan(expiryHours + 'æ™‚é–“')}`);
        const { confirm } = await inquirer_1.default.prompt([
            {
                type: 'confirm',
                name: 'confirm',
                message: 'ã“ã®è¨­å®šã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±æœ‰ã—ã¾ã™ã‹ï¼Ÿ',
                default: true
            }
        ]);
        if (!confirm) {
            console.log(chalk_1.default.yellow('âŒ ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ'));
            return;
        }
        // APIå‘¼ã³å‡ºã—
        const response = await fetch(`${config.server_url}/api/file-sharing/${roomSlug}/shares`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                owner_username: username,
                file_path: absolutePath,
                file_name: fileName,
                file_content: fileContent,
                file_type: fileType,
                target_users: targetUsers,
                permission_type: permission,
                expiry_hours: expiryHours
            })
        });
        const result = await response.json();
        if (result.success) {
            console.log(chalk_1.default.green('\nâœ… ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼'));
            console.log(chalk_1.default.gray(`å…±æœ‰ãƒˆãƒ¼ã‚¯ãƒ³: ${result.data.share_token}`));
            console.log(chalk_1.default.gray(`æœ‰åŠ¹æœŸé™: ${new Date(result.data.expires_at).toLocaleString()}`));
            if (targetUsers.length > 0) {
                console.log(chalk_1.default.blue(`\nğŸ“¬ ${targetUsers.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…±æœ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ`));
                console.log(chalk_1.default.yellow('ğŸ’¡ ç›¸æ‰‹ãŒæ‰¿èªã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„'));
            }
            else {
                console.log(chalk_1.default.blue('\nğŸ“¬ ãƒ«ãƒ¼ãƒ å†…ã®å…¨å‚åŠ è€…ã«å…±æœ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ'));
            }
        }
        else {
            console.error(chalk_1.default.red('âŒ ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:'), result.error);
        }
    }
    catch (error) {
        console.error(chalk_1.default.red('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'), error);
    }
}
async function listSharedFiles(roomSlug) {
    try {
        const config = await (0, config_1.loadConfig)();
        if (!config.server_url || !config.default_username) {
            console.error(chalk_1.default.red('âŒ è¨­å®šãŒä¸å®Œå…¨ã§ã™'));
            console.log(chalk_1.default.yellow('ğŸ’¡ è¨­å®šæ–¹æ³•: ') + chalk_1.default.cyan('kawazu config'));
            return;
        }
        // ãƒ«ãƒ¼ãƒ æƒ…å ±å–å¾—
        if (!roomSlug) {
            roomSlug = await (0, file_1.getCurrentRoomFromCodechat)();
            if (!roomSlug) {
                console.error(chalk_1.default.red('âŒ ãƒ«ãƒ¼ãƒ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'));
                return;
            }
        }
        const response = await fetch(`${config.server_url}/api/file-sharing/${roomSlug}/shares?username=${config.default_username}`);
        const result = await response.json();
        if (result.success) {
            const files = result.data;
            if (files.length === 0) {
                console.log(chalk_1.default.yellow('ğŸ“ å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“'));
                return;
            }
            console.log(chalk_1.default.blue.bold(`\nğŸ“ å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ (${roomSlug})\n`));
            files.forEach((file, index) => {
                const statusColor = file.status === 'approved' ? chalk_1.default.green :
                    file.status === 'denied' ? chalk_1.default.red : chalk_1.default.yellow;
                const permissionIcon = file.permission_type === 'write' ? 'âœï¸' : 'ğŸ‘€';
                console.log(`${index + 1}. ${permissionIcon} ${chalk_1.default.cyan(file.file_name)}`);
                console.log(`   æ‰€æœ‰è€…: ${chalk_1.default.gray(file.owner_username)}`);
                console.log(`   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusColor(getStatusText(file.status))}`);
                console.log(`   æ¨©é™: ${chalk_1.default.gray(file.permission_type === 'read' ? 'èª­ã¿å–ã‚Šå°‚ç”¨' : 'èª­ã¿æ›¸ãå¯èƒ½')}`);
                if (file.expires_at) {
                    const expiresAt = new Date(file.expires_at);
                    const isExpired = expiresAt < new Date();
                    console.log(`   æœ‰åŠ¹æœŸé™: ${isExpired ? chalk_1.default.red('æœŸé™åˆ‡ã‚Œ') : chalk_1.default.gray(expiresAt.toLocaleString())}`);
                }
                console.log(`   ãƒˆãƒ¼ã‚¯ãƒ³: ${chalk_1.default.gray(file.share_token)}`);
                console.log('');
            });
        }
        else {
            console.error(chalk_1.default.red('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:'), result.error);
        }
    }
    catch (error) {
        console.error(chalk_1.default.red('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'), error);
    }
}
async function downloadSharedFile(shareToken, outputPath) {
    try {
        const config = await (0, config_1.loadConfig)();
        if (!config.server_url || !config.default_username) {
            console.error(chalk_1.default.red('âŒ è¨­å®šãŒä¸å®Œå…¨ã§ã™'));
            return;
        }
        const response = await fetch(`${config.server_url}/api/file-sharing/shares/${shareToken}/content?username=${config.default_username}`);
        const result = await response.json();
        if (result.success) {
            const data = result.data;
            const fileName = outputPath || data.file_name;
            const filePath = path_1.default.resolve(fileName);
            // ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šæ›¸ãç¢ºèª
            if (fs_extra_1.default.existsSync(filePath)) {
                const { overwrite } = await inquirer_1.default.prompt([
                    {
                        type: 'confirm',
                        name: 'overwrite',
                        message: `ãƒ•ã‚¡ã‚¤ãƒ« ${fileName} ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`,
                        default: false
                    }
                ]);
                if (!overwrite) {
                    console.log(chalk_1.default.yellow('âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ'));
                    return;
                }
            }
            // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
            await fs_extra_1.default.writeFile(filePath, data.file_content, 'utf-8');
            console.log(chalk_1.default.green(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ${fileName}`));
            console.log(chalk_1.default.gray(`æ‰€æœ‰è€…: ${data.owner_username}`));
            console.log(chalk_1.default.gray(`æ¨©é™: ${data.permission_type === 'read' ? 'èª­ã¿å–ã‚Šå°‚ç”¨' : 'èª­ã¿æ›¸ãå¯èƒ½'}`));
            if (data.expires_at) {
                console.log(chalk_1.default.gray(`æœ‰åŠ¹æœŸé™: ${new Date(data.expires_at).toLocaleString()}`));
            }
        }
        else {
            console.error(chalk_1.default.red('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:'), result.error);
        }
    }
    catch (error) {
        console.error(chalk_1.default.red('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'), error);
    }
}
async function revokeFileShare(shareToken) {
    try {
        const config = await (0, config_1.loadConfig)();
        if (!config.server_url || !config.default_username) {
            console.error(chalk_1.default.red('âŒ è¨­å®šãŒä¸å®Œå…¨ã§ã™'));
            return;
        }
        const { confirm } = await inquirer_1.default.prompt([
            {
                type: 'confirm',
                name: 'confirm',
                message: 'ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ',
                default: false
            }
        ]);
        if (!confirm) {
            console.log(chalk_1.default.yellow('âŒ å–ã‚Šæ¶ˆã—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ'));
            return;
        }
        const response = await fetch(`${config.server_url}/api/file-sharing/shares/${shareToken}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: config.default_username
            })
        });
        const result = await response.json();
        if (result.success) {
            console.log(chalk_1.default.green('âœ… ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ'));
            console.log(chalk_1.default.gray(`ãƒ•ã‚¡ã‚¤ãƒ«: ${result.data.file_name}`));
        }
        else {
            console.error(chalk_1.default.red('âŒ ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã®å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ:'), result.error);
        }
    }
    catch (error) {
        console.error(chalk_1.default.red('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'), error);
    }
}
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function getFileType(extension) {
    const typeMap = {
        '.js': 'javascript',
        '.ts': 'typescript',
        '.jsx': 'javascript',
        '.tsx': 'typescript',
        '.py': 'python',
        '.java': 'java',
        '.cpp': 'cpp',
        '.c': 'c',
        '.cs': 'csharp',
        '.php': 'php',
        '.rb': 'ruby',
        '.go': 'go',
        '.rs': 'rust',
        '.html': 'html',
        '.css': 'css',
        '.scss': 'scss',
        '.sass': 'sass',
        '.json': 'json',
        '.xml': 'xml',
        '.yml': 'yaml',
        '.yaml': 'yaml',
        '.md': 'markdown',
        '.txt': 'text',
        '.sh': 'bash',
        '.sql': 'sql'
    };
    return typeMap[extension.toLowerCase()] || 'text';
}
function getStatusText(status) {
    switch (status) {
        case 'pending': return 'æ‰¿èªå¾…ã¡';
        case 'approved': return 'æ‰¿èªæ¸ˆã¿';
        case 'denied': return 'æ‹’å¦';
        default: return status;
    }
}
