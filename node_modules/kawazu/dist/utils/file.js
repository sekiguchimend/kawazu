"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCodechatPath = getCodechatPath;
exports.createCodechatFile = createCodechatFile;
exports.appendMessageToFile = appendMessageToFile;
exports.readFileContent = readFileContent;
exports.ensureDirectory = ensureDirectory;
exports.isValidRoomSlug = isValidRoomSlug;
exports.getCurrentRoomFromCodechat = getCurrentRoomFromCodechat;
exports.getCodechatFiles = getCodechatFiles;
exports.clearInputArea = clearInputArea;
exports.createCommandHelpFile = createCommandHelpFile;
const fs = __importStar(require("fs-extra"));
const path = __importStar(require("path"));
function getCodechatPath(roomSlug, workingDir = process.cwd()) {
    return path.join(workingDir, `${roomSlug}.codechat`);
}
async function createCodechatFile(filePath, roomSlug, username) {
    const initialContent = `================================================================================
 File: ${roomSlug}.codechat
================================================================================

 Room: ${roomSlug}
 User: ${username}
 Max Messages: 7 (æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤º)

================================================================================

ğŸ’­ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼

================================================================================


------------------------------------------------------------------------------>
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã®ç·šä¸Šã«æ›¸ã

================================================================================
`;
    await fs.writeFile(filePath, initialContent, 'utf8');
    // ã‚³ãƒãƒ³ãƒ‰ãƒ˜ãƒ«ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
    await createCommandHelpFile(path.dirname(filePath), roomSlug);
}
async function appendMessageToFile(filePath, message) {
    try {
        // ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿å–ã‚Š
        const currentContent = await fs.readFile(filePath, 'utf8');
        // æ–°ã—ã„å½¢å¼ã®å¢ƒç•Œã‚’ç‰¹å®š
        const headerEnd = '================================================================================';
        const inputLineStart = '------------------------------------------------------------------------------>';
        const firstHeaderIndex = currentContent.indexOf(headerEnd);
        const secondHeaderIndex = currentContent.indexOf(headerEnd, firstHeaderIndex + 1);
        const thirdHeaderIndex = currentContent.indexOf(headerEnd, secondHeaderIndex + 1);
        const inputLineIndex = currentContent.lastIndexOf(inputLineStart);
        if (firstHeaderIndex !== -1 && secondHeaderIndex !== -1 && thirdHeaderIndex !== -1 && inputLineIndex !== -1) {
            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
            const headerPart = currentContent.substring(0, secondHeaderIndex + headerEnd.length);
            // ç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éƒ¨åˆ†
            const messagePart = currentContent.substring(secondHeaderIndex + headerEnd.length, thirdHeaderIndex);
            // ãƒ•ãƒƒã‚¿ãƒ¼éƒ¨åˆ†ï¼ˆå…¥åŠ›ã‚¨ãƒªã‚¢ä»¥é™ï¼‰
            const footerStart = currentContent.substring(thirdHeaderIndex);
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
            const existingMessages = extractMessagesFromContent(messagePart);
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            existingMessages.push(message);
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’7å€‹ã«åˆ¶é™
            const limitedMessages = existingMessages.slice(-7);
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éƒ¨åˆ†ã‚’æ§‹ç¯‰
            const newMessagePart = buildMessageContent(limitedMessages);
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’å†æ§‹ç¯‰
            const newContent = headerPart + '\n' + newMessagePart + '\n' + footerStart;
            await fs.writeFile(filePath, newContent, 'utf8');
        }
        else {
            console.error('ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒèªè­˜ã§ãã¾ã›ã‚“');
        }
    }
    catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
}
function extractMessagesFromContent(messageSection) {
    const messages = [];
    const lines = messageSection.split('\n');
    let currentMessage = '';
    let collectingMessage = false;
    for (const line of lines) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é–‹å§‹ã‚’æ¤œå‡ºï¼ˆ[æ™‚åˆ»] ã§å§‹ã¾ã‚‹è¡Œï¼‰
        if (line.match(/^\[[\d:]+\]/)) {
            // å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
            if (currentMessage.trim()) {
                messages.push(currentMessage.trim());
            }
            currentMessage = line;
            collectingMessage = true;
        }
        else if (collectingMessage && line.trim() !== '') {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¶šãã‚’è¿½åŠ 
            currentMessage += '\n' + line;
        }
        else if (collectingMessage && line.trim() === '') {
            // ç©ºè¡Œã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ‚äº†
            if (currentMessage.trim()) {
                messages.push(currentMessage.trim());
            }
            currentMessage = '';
            collectingMessage = false;
        }
    }
    // æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
    if (currentMessage.trim()) {
        messages.push(currentMessage.trim());
    }
    return messages.filter(msg => msg.length > 0 && !msg.includes('ğŸ’­ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼'));
}
function extractExistingMessages(historySection) {
    const messages = [];
    const lines = historySection.split('\n');
    let currentMessage = '';
    let insideMessage = false;
    for (const line of lines) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é–‹å§‹ã‚’æ¤œå‡ºï¼ˆâ”Œâ”€ ã§å§‹ã¾ã‚‹è¡Œï¼‰
        if (line.includes('â”Œâ”€') && !line.includes('ãƒãƒ£ãƒƒãƒˆå±¥æ­´')) {
            if (currentMessage.trim()) {
                messages.push(currentMessage.trim());
            }
            currentMessage = line + '\n';
            insideMessage = true;
        }
        else if (insideMessage) {
            currentMessage += line + '\n';
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ‚äº†ã‚’æ¤œå‡ºï¼ˆâ””â”€ ã§å§‹ã¾ã‚‹è¡Œï¼‰
            if (line.includes('â””â”€')) {
                messages.push(currentMessage.trim());
                currentMessage = '';
                insideMessage = false;
            }
        }
    }
    return messages.filter(msg => msg.length > 0 && !msg.includes('ğŸ’­ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼'));
}
function buildMessageContent(messages) {
    if (messages.length === 0) {
        return 'ğŸ’­ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼';
    }
    // 7ã¤ä»¥ä¸Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯ã€å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã®è¡¨ç¤ºã‚’è¿½åŠ 
    let content = '';
    if (messages.length >= 7) {
        content += 'â–² å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ï¼ˆ7ã¤ã¾ã§è¡¨ç¤ºï¼‰\n\n';
    }
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    for (let i = 0; i < messages.length; i++) {
        content += messages[i];
        if (i < messages.length - 1) {
            content += '\n';
        }
    }
    return content;
}
function buildChatHistory(messages) {
    const chatHistoryStart = 'â•”â• ãƒãƒ£ãƒƒãƒˆå±¥æ­´ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
    const chatHistoryEnd = 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
    let historyContent = chatHistoryStart + '\n';
    if (messages.length === 0) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆã¯åˆæœŸçŠ¶æ…‹
        for (let i = 0; i < 18; i++) {
            if (i === 9) {
                historyContent += 'â•‘                          ğŸ’­ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼                    â•‘\n';
            }
            else {
                historyContent += 'â•‘                                                                           â•‘\n';
            }
        }
    }
    else {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
        let lineCount = 0;
        const maxLines = 18;
        for (const message of messages) {
            const messageLines = message.split('\n');
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰ã«ç©ºè¡Œã‚’è¿½åŠ 
            if (lineCount > 0 && lineCount < maxLines) {
                historyContent += 'â•‘                                                                           â•‘\n';
                lineCount++;
            }
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            for (const line of messageLines) {
                if (lineCount < maxLines) {
                    historyContent += line + '\n';
                    lineCount++;
                }
            }
        }
        // æ®‹ã‚Šã®è¡Œã‚’ç©ºè¡Œã§åŸ‹ã‚ã‚‹
        while (lineCount < maxLines) {
            historyContent += 'â•‘                                                                           â•‘\n';
            lineCount++;
        }
    }
    historyContent += chatHistoryEnd;
    return historyContent;
}
async function readFileContent(filePath) {
    try {
        return await fs.readFile(filePath, 'utf8');
    }
    catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼:', error);
        return '';
    }
}
async function ensureDirectory(dirPath) {
    await fs.ensureDir(dirPath);
}
function isValidRoomSlug(slug) {
    return /^[a-zA-Z0-9-_]+$/.test(slug);
}
async function getCurrentRoomFromCodechat() {
    try {
        const currentDir = process.cwd();
        const files = await fs.readdir(currentDir);
        // .codechatãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
        const codechatFiles = files.filter(file => file.endsWith('.codechat'));
        if (codechatFiles.length === 0) {
            return null;
        }
        // æœ€åˆã®.codechatãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ«ãƒ¼ãƒ åã‚’æŠ½å‡º
        const codechatFile = codechatFiles[0];
        const roomSlug = codechatFile.replace('.codechat', '');
        return roomSlug;
    }
    catch (error) {
        console.error('ãƒ«ãƒ¼ãƒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return null;
    }
}
async function getCodechatFiles() {
    try {
        const currentDir = process.cwd();
        const files = await fs.readdir(currentDir);
        return files.filter(file => file.endsWith('.codechat'));
    }
    catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return [];
    }
}
async function clearInputArea(filePath) {
    try {
        const currentContent = await fs.readFile(filePath, 'utf8');
        // å…¥åŠ›ç·šã®ä¸Šã®éƒ¨åˆ†ã‚’ã‚¯ãƒªã‚¢
        const inputLineStart = '------------------------------------------------------------------------------>';
        const inputLineIndex = currentContent.lastIndexOf(inputLineStart);
        if (inputLineIndex !== -1) {
            // å…¥åŠ›ç·šã‚ˆã‚Šå‰ã®éƒ¨åˆ†ã‚’å–å¾—
            const beforeInputLine = currentContent.substring(0, inputLineIndex);
            // æœ€å¾Œã®åŒºåˆ‡ã‚Šç·šï¼ˆ================ï¼‰ã‚’è¦‹ã¤ã‘ã‚‹
            const lastSeparator = '================================================================================';
            const lastSeparatorIndex = beforeInputLine.lastIndexOf(lastSeparator);
            if (lastSeparatorIndex !== -1) {
                const beforeMessages = beforeInputLine.substring(0, lastSeparatorIndex + lastSeparator.length);
                const inputArea = currentContent.substring(inputLineIndex);
                // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ï¼ˆç©ºè¡Œ2ã¤ + å…¥åŠ›ç·šä»¥é™ï¼‰
                const cleanContent = beforeMessages + '\n\n\n' + inputArea;
                await fs.writeFile(filePath, cleanContent, 'utf8');
            }
        }
    }
    catch (error) {
        console.error('å…¥åŠ›ã‚¨ãƒªã‚¢ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
    }
}
async function createCommandHelpFile(dirPath, roomSlug) {
    const helpFilePath = path.join(dirPath, `${roomSlug}-commands.kawazu`);
    const helpContent = `================================================================================
 Kawazu ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ - ${roomSlug}
================================================================================

ğŸ“‹ åŸºæœ¬æ“ä½œ:
  â€¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: .codechatãƒ•ã‚¡ã‚¤ãƒ«ã§ç·¨é›†å¾Œ Ctrl+S
  â€¢ ãƒãƒ£ãƒƒãƒˆçµ‚äº†: Ctrl+C

ğŸ”§ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:

ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰:
  kawazu share /path/to/file.js
  â””â”€ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»–ã®å‚åŠ è€…ã¨å…±æœ‰ï¼ˆæ‰¿èªãŒå¿…è¦ï¼‰

ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:
  kawazu profile ãƒ¦ãƒ¼ã‚¶ãƒ¼å
  â””â”€ æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤º

ğŸ  ãƒ«ãƒ¼ãƒ æ“ä½œ:
  kawazu list
  â””â”€ å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤º
  
  kawazu create "æ–°ã—ã„ãƒ«ãƒ¼ãƒ å"
  â””â”€ æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ

ğŸ” èªè¨¼ãƒ»ãƒ—ãƒ©ãƒ³:
  kawazu login
  â””â”€ Webã‚¢ãƒ—ãƒªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
  
  kawazu logout
  â””â”€ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  
  kawazu whoami
  â””â”€ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
  
  kawazu plan
  â””â”€ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’ç¢ºèª

ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼:
  â€¢ ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
  â€¢ ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯: \`\`\`è¨€èªå ã§é–‹å§‹
  â€¢ çµµæ–‡å­—å¯¾å¿œ

ğŸ“Š åˆ¶é™äº‹é …:
  â€¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´: 7ã¤ã¾ã§ï¼ˆå¤ã„ã‚‚ã®ã¯è‡ªå‹•å‰Šé™¤ï¼‰
  â€¢ ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰: ãƒ—ãƒ©ãƒ³ã«å¿œã˜ãŸå®¹é‡åˆ¶é™
  â€¢ ãƒ«ãƒ¼ãƒ ä½œæˆæ•°: ãƒ—ãƒ©ãƒ³ã«å¿œã˜ãŸåˆ¶é™

================================================================================
`;
    await fs.writeFile(helpFilePath, helpContent, 'utf8');
    console.log(`ğŸ“– ã‚³ãƒãƒ³ãƒ‰ãƒ˜ãƒ«ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ: ${roomSlug}-commands.kawazu`);
}
