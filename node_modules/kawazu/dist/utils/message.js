"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.detectMessageType = detectMessageType;
exports.formatMessage = formatMessage;
exports.sanitizeMessage = sanitizeMessage;
exports.isSystemMessage = isSystemMessage;
exports.extractNewContent = extractNewContent;
exports.isFileShareCommand = isFileShareCommand;
exports.parseFileShareCommand = parseFileShareCommand;
function detectMessageType(content) {
    return content.includes('```') ? 'code' : 'text';
}
function formatMessage(username, content, timestamp, isOwnMessage = false) {
    const time = new Date(timestamp).toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit'
    });
    const userIcon = getUserIcon(username);
    const userColor = getUserColor(username);
    const isCode = content.includes('```');
    if (isCode) {
        return formatCodeMessage(username, content, time, userIcon, userColor, isOwnMessage);
    }
    // é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    return formatTextMessage(username, content, time, userIcon, userColor, isOwnMessage);
}
function formatTextMessage(username, content, time, icon, color, isOwnMessage) {
    const messageWidth = 65; // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¨ãƒªã‚¢å†…ã®å¹…
    const maxContentWidth = 45;
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’é©åˆ‡ã«åˆ†å‰²
    const wrappedContent = wrapText(content, maxContentWidth);
    if (isOwnMessage) {
        // å³å¯„ã›ï¼ˆè‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
        const headerLine = `${time} â”€ ${username} ${icon}`.padStart(messageWidth);
        const contentLines = wrappedContent.map(line => `â•‘${(' '.repeat(messageWidth - line.length - 3))}${line}  â•‘`);
        return `â•‘${' '.repeat(messageWidth - 2)}â•‘
â•‘${' '.repeat(Math.max(0, messageWidth - headerLine.length - 2))}${color}â”Œâ”€${headerLine}â”€â”${'\x1b[0m'}â•‘
${contentLines.join('\n')}
â•‘${' '.repeat(Math.max(0, messageWidth - 2))}${color}â””${'â”€'.repeat(Math.min(headerLine.length + 4, messageWidth - 4))}â”˜${'\x1b[0m'}â•‘`;
    }
    else {
        // å·¦å¯„ã›ï¼ˆä»–ã®äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
        const headerLine = `${icon} ${username} â”€ ${time}`;
        const contentLines = wrappedContent.map(line => `â•‘  ${line}${' '.repeat(Math.max(0, messageWidth - line.length - 4))}â•‘`);
        return `â•‘${' '.repeat(messageWidth - 2)}â•‘
â•‘${color}â”Œâ”€${headerLine}${'â”€'.repeat(Math.max(0, messageWidth - headerLine.length - 6))}â”${'\x1b[0m'}â•‘
${contentLines.join('\n')}
â•‘${color}â””${'â”€'.repeat(Math.min(headerLine.length + 2, messageWidth - 4))}â”˜${'\x1b[0m'}â•‘`;
    }
}
function getUserIcon(username) {
    const icons = ['ğŸ‘¤', 'ğŸ‘¨', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ¼', 'ğŸ¤–', 'ğŸ‘½', 'ğŸ­', 'ğŸ¦„', 'ğŸ”¥'];
    const hash = username.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
    return icons[hash % icons.length];
}
function getUserColor(username) {
    // ANSIè‰²ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«å¯¾å¿œï¼‰
    const colors = [
        '\x1b[94m', // æ˜ã‚‹ã„é’
        '\x1b[92m', // æ˜ã‚‹ã„ç·‘  
        '\x1b[95m', // æ˜ã‚‹ã„ãƒã‚¼ãƒ³ã‚¿
        '\x1b[96m', // æ˜ã‚‹ã„ã‚·ã‚¢ãƒ³
        '\x1b[93m', // æ˜ã‚‹ã„é»„è‰²
        '\x1b[91m', // æ˜ã‚‹ã„èµ¤
        '\x1b[97m', // æ˜ã‚‹ã„ç™½
        '\x1b[90m', // æ˜ã‚‹ã„é»’
    ];
    const hash = username.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
    return colors[hash % colors.length];
}
function wrapText(text, maxWidth) {
    const words = text.split(' ');
    const lines = [];
    let currentLine = '';
    for (const word of words) {
        if ((currentLine + word).length <= maxWidth) {
            currentLine += (currentLine ? ' ' : '') + word;
        }
        else {
            if (currentLine) {
                lines.push(currentLine);
            }
            currentLine = word;
        }
    }
    if (currentLine) {
        lines.push(currentLine);
    }
    return lines.length ? lines : [''];
}
function formatCodeMessage(username, content, time, icon, color, isOwnMessage) {
    const messageWidth = 65;
    const codeBlocks = content.split('```');
    if (isOwnMessage) {
        // å³å¯„ã›ã‚³ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const headerLine = `${time} â”€ ${username} ${icon} ğŸ’»`;
        let formatted = `â•‘${' '.repeat(messageWidth - 2)}â•‘
â•‘${' '.repeat(Math.max(0, messageWidth - headerLine.length - 6))}${color}â”Œâ”€${headerLine}â”€â”${'\x1b[0m'}â•‘\n`;
        for (let i = 0; i < codeBlocks.length; i++) {
            if (i % 2 === 1) { // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…
                const codeLines = codeBlocks[i].split('\n').filter(line => line.trim());
                codeLines.forEach(line => {
                    const truncatedLine = line.substring(0, 50);
                    formatted += `â•‘${' '.repeat(Math.max(0, messageWidth - truncatedLine.length - 5))}\x1b[100m${truncatedLine}\x1b[0m  â•‘\n`;
                });
            }
            else if (codeBlocks[i].trim()) { // ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†
                const textLine = codeBlocks[i].trim().substring(0, 50);
                formatted += `â•‘${' '.repeat(Math.max(0, messageWidth - textLine.length - 5))}${textLine}  â•‘\n`;
            }
        }
        formatted += `â•‘${' '.repeat(Math.max(0, messageWidth - headerLine.length - 4))}${color}â””${'â”€'.repeat(Math.min(headerLine.length + 2, messageWidth - 6))}â”˜${'\x1b[0m'}â•‘`;
        return formatted;
    }
    else {
        // å·¦å¯„ã›ã‚³ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const headerLine = `${icon} ${username} â”€ ${time} ğŸ’»`;
        let formatted = `â•‘${' '.repeat(messageWidth - 2)}â•‘
â•‘${color}â”Œâ”€${headerLine}${'â”€'.repeat(Math.max(0, messageWidth - headerLine.length - 6))}â”${'\x1b[0m'}â•‘\n`;
        for (let i = 0; i < codeBlocks.length; i++) {
            if (i % 2 === 1) { // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…
                const codeLines = codeBlocks[i].split('\n').filter(line => line.trim());
                codeLines.forEach(line => {
                    const truncatedLine = line.substring(0, 55);
                    formatted += `â•‘  \x1b[100m${truncatedLine.padEnd(55)}\x1b[0m  â•‘\n`;
                });
            }
            else if (codeBlocks[i].trim()) { // ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†
                const textLine = codeBlocks[i].trim();
                formatted += `â•‘  ${textLine.substring(0, 55).padEnd(55)}  â•‘\n`;
            }
        }
        formatted += `â•‘${color}â””${'â”€'.repeat(Math.min(headerLine.length + 2, messageWidth - 4))}â”˜${'\x1b[0m'}â•‘`;
        return formatted;
    }
}
function sanitizeMessage(content) {
    // åŸºæœ¬çš„ãªã‚µãƒ‹ã‚¿ã‚¤ã‚º
    return content
        .trim()
        .replace(/[\r\n]+/g, '\n') // æ”¹è¡Œã‚’çµ±ä¸€
        .substring(0, 10000); // é•·ã•åˆ¶é™
}
function isSystemMessage(line) {
    const trimmed = line.trim();
    return trimmed.startsWith('#') || trimmed.startsWith('[') || trimmed.length === 0;
}
function extractNewContent(currentContent, lastContent) {
    console.log('ğŸ” extractNewContent é–‹å§‹');
    // æ–°ã—ã„ç·šå½¢å¼ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å®šç¾©
    const inputLineStart = '------------------------------------------------------------------------------>';
    const separatorLine = '================================================================================';
    console.log('ğŸ” ãƒãƒ¼ã‚«ãƒ¼å®šç¾©:', { inputLineStart: inputLineStart.substring(0, 20) + '...', separatorLine: separatorLine.substring(0, 20) + '...' });
    // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’æŠ½å‡º
    const currentInputArea = extractInputAreaFromContent(currentContent);
    console.log('ğŸ” ç¾åœ¨ã®å…¥åŠ›ã‚¨ãƒªã‚¢:', `"${currentInputArea}"`);
    if (!currentInputArea) {
        console.log('ğŸ” ç¾åœ¨ã®å…¥åŠ›ã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return '';
    }
    // å‰å›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’æŠ½å‡º
    const lastInputArea = lastContent ? extractInputAreaFromContent(lastContent) : '';
    console.log('ğŸ” å‰å›ã®å…¥åŠ›ã‚¨ãƒªã‚¢:', `"${lastInputArea}"`);
    // ä¸¡æ–¹ã®ã‚¨ãƒªã‚¢ã‚’è¡Œã«åˆ†å‰²ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const currentLines = cleanupMessageLines(currentInputArea.split('\n'));
    const lastLines = lastContent ? cleanupMessageLines(lastInputArea.split('\n')) : [];
    console.log('ğŸ” ç¾åœ¨ã®ã‚¯ãƒªãƒ¼ãƒ³ãªè¡Œ:', currentLines);
    console.log('ğŸ” å‰å›ã®ã‚¯ãƒªãƒ¼ãƒ³ãªè¡Œ:', lastLines);
    // å·®åˆ†ã‚’æ¤œå‡ºã—ã¦æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’æŠ½å‡º
    const newLines = detectNewLines(currentLines, lastLines);
    console.log('ğŸ” æ¤œå‡ºã•ã‚ŒãŸæ–°ã—ã„è¡Œ:', newLines);
    // çµæœã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦è¿”ã™
    const result = newLines.join('\n').trim();
    console.log('ğŸ” extractNewContent çµæœ:', `"${result}"`);
    return result;
}
function extractInputAreaFromContent(content) {
    console.log('ğŸ” extractInputAreaFromContent é–‹å§‹');
    const inputLineStart = '------------------------------------------------------------------------------>';
    const separatorLine = '================================================================================';
    // æœ€æ–°ã®å…¥åŠ›ç·šã‚’è¦‹ã¤ã‘ã‚‹
    const inputLineIndex = content.lastIndexOf(inputLineStart);
    console.log('ğŸ” å…¥åŠ›ç·šã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', inputLineIndex);
    if (inputLineIndex === -1) {
        console.log('ğŸ” å…¥åŠ›ç·šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return '';
    }
    // å…¥åŠ›ç·šã‚ˆã‚Šå‰ã®éƒ¨åˆ†ã‚’å–å¾—
    const beforeInputLine = content.substring(0, inputLineIndex);
    console.log('ğŸ” å…¥åŠ›ç·šã‚ˆã‚Šå‰ã®æ–‡å­—æ•°:', beforeInputLine.length);
    // æœ€å¾Œã®åŒºåˆ‡ã‚Šç·šã‚’è¦‹ã¤ã‘ã‚‹
    const lastSeparatorIndex = beforeInputLine.lastIndexOf(separatorLine);
    console.log('ğŸ” æœ€å¾Œã®åŒºåˆ‡ã‚Šç·šã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', lastSeparatorIndex);
    if (lastSeparatorIndex === -1) {
        console.log('ğŸ” åŒºåˆ‡ã‚Šç·šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return '';
    }
    // åŒºåˆ‡ã‚Šç·šã‹ã‚‰å…¥åŠ›ç·šã¾ã§ã®å†…å®¹ã‚’æŠ½å‡º
    const result = beforeInputLine.substring(lastSeparatorIndex + separatorLine.length);
    console.log('ğŸ” æŠ½å‡ºã•ã‚ŒãŸå…¥åŠ›ã‚¨ãƒªã‚¢:', `"${result}"`);
    return result;
}
function cleanupMessageLines(lines) {
    console.log('ğŸ” cleanupMessageLines é–‹å§‹');
    console.log('ğŸ” å…ƒã®è¡Œæ•°:', lines.length);
    console.log('ğŸ” å…ƒã®è¡Œ:', lines);
    const result = lines
        .map(line => line.trim())
        .filter(line => {
        if (!line) {
            console.log('ğŸ” ç©ºè¡Œã‚’é™¤å¤–:', `"${line}"`);
            return false;
        }
        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’é™¤å¤–
        if (line.includes('ğŸ’­ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼')) {
            console.log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤å¤–:', `"${line}"`);
            return false;
        }
        if (line.includes('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·šã®ä¸Šã«æ›¸ã')) {
            console.log('ğŸ” ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’é™¤å¤–:', `"${line}"`);
            return false;
        }
        if (line.includes('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã¨é€ä¿¡ã•ã‚Œã¾ã™')) {
            console.log('ğŸ” ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’é™¤å¤–:', `"${line}"`);
            return false;
        }
        if (line.includes('Ctrl+C ã§çµ‚äº†')) {
            console.log('ğŸ” ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’é™¤å¤–:', `"${line}"`);
            return false;
        }
        // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’é™¤å¤–
        if (isSystemMessage(line)) {
            console.log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤å¤–:', `"${line}"`);
            return false;
        }
        console.log('ğŸ” æœ‰åŠ¹ãªè¡Œã¨ã—ã¦æ¡ç”¨:', `"${line}"`);
        return true;
    });
    console.log('ğŸ” cleanupMessageLines çµæœ:', result);
    return result;
}
function detectNewLines(currentLines, lastLines) {
    console.log('ğŸ” detectNewLines é–‹å§‹');
    console.log('ğŸ” ç¾åœ¨ã®è¡Œæ•°:', currentLines.length);
    console.log('ğŸ” å‰å›ã®è¡Œæ•°:', lastLines.length);
    // å‰å›ã®è¡Œæ•°ã‚ˆã‚Šå¤šã„å ´åˆã€æ–°ã—ã„è¡ŒãŒã‚ã‚‹ã¨ã„ã†ã“ã¨
    if (currentLines.length > lastLines.length) {
        const newLines = currentLines.slice(lastLines.length);
        console.log('ğŸ” æ–°ã—ã„è¡Œã‚’æ¤œå‡ºï¼ˆè¡Œæ•°å¢—åŠ ï¼‰:', newLines);
        return newLines;
    }
    // åŒã˜é•·ã•ã®å ´åˆã€æœ€å¾Œã®è¡ŒãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (currentLines.length === lastLines.length && currentLines.length > 0) {
        const lastCurrentLine = currentLines[currentLines.length - 1];
        const lastPreviousLine = lastLines.length > 0 ? lastLines[lastLines.length - 1] : '';
        console.log('ğŸ” æœ€å¾Œã®è¡Œã®æ¯”è¼ƒ:');
        console.log('ğŸ” ç¾åœ¨ã®æœ€å¾Œã®è¡Œ:', `"${lastCurrentLine}"`);
        console.log('ğŸ” å‰å›ã®æœ€å¾Œã®è¡Œ:', `"${lastPreviousLine}"`);
        if (lastCurrentLine !== lastPreviousLine) {
            // æœ€å¾Œã®è¡ŒãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®è¡Œã®ã¿ã‚’è¿”ã™
            console.log('ğŸ” æœ€å¾Œã®è¡ŒãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', [lastCurrentLine]);
            return [lastCurrentLine];
        }
    }
    console.log('ğŸ” æ–°ã—ã„è¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    return [];
}
function isKawazuCommand(line) {
    const trimmed = line.trim();
    return trimmed.startsWith('kawazu ') || isFileShareCommand(trimmed);
}
function isFileShareCommand(line) {
    const trimmed = line.trim();
    return trimmed.startsWith('#share ') || trimmed.startsWith('#approve ') || trimmed.startsWith('#deny ');
}
function parseFileShareCommand(line) {
    const trimmed = line.trim();
    // #share ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ @user1 @user2 --write
    if (trimmed.startsWith('#share ')) {
        const parts = trimmed.substring(7).split(' ');
        const filePath = parts[0];
        const users = parts.filter(p => p.startsWith('@')).map(u => u.substring(1));
        const permission = parts.includes('--write') ? 'write' : 'read';
        return {
            command: 'share',
            filePath,
            users: users.length > 0 ? users : undefined,
            permission
        };
    }
    // #approve ãƒˆãƒ¼ã‚¯ãƒ³
    if (trimmed.startsWith('#approve ')) {
        const token = trimmed.substring(9).trim();
        return {
            command: 'approve',
            token
        };
    }
    // #deny ãƒˆãƒ¼ã‚¯ãƒ³
    if (trimmed.startsWith('#deny ')) {
        const token = trimmed.substring(6).trim();
        return {
            command: 'deny',
            token
        };
    }
    return null;
}
